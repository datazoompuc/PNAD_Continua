V20081 != 99 & V20082 != 9999,
100*(n_p-1) + V2003, NA)) %>%
loop() %>%
ungroup() %>%
mutate_at(c('UF', 'UPA', 'V1008', 'p201'), as.character) %>%
mutate(UPA = str_pad(UPA,9, pad = "0"),
V1008 = str_pad(V1008,3, pad = "0"),
p201 = str_pad(p201,3, pad = "0")) %>%
mutate(idind = ifelse(is.na(p201),
NA,
paste0(V1014, UF, UPA, V1008, p201))) %>%
select(-c(p201, n_p, n_p_aux)) %>%
arrange(Ano, Trimestre, idind, UPA, V2003) %>%
set_variable_labels(.labels =  var_label(dados_prontos[[1]]))
)
return(paineis)
}
loop <- function(data,
interview = 2,
int_final = 5){
data <- data %>%
group_by(UF, UPA, V1008, V1014, V2007,
V2008, V20081, V20082, V2003) %>%
fill(p201, .direction = 'down') %>%
mutate(p201 = ifelse(
n_p %in% 1:(interview-1),
p201,
ifelse(
n_p == interview  & is.na(p201) &
V2008 != 99 &
V20081 != 99 & V20082 != 9999,
100 * (n_p - 1) + V2003,
NA
)
))
if(interview == int_final){
return(data)
} else{
return(loop(data, interview + 1, int_final))
}
}
cteste <- pnadc_painel_basico(build_data = FALSE,
dados_prontos = a)
teste <- pnadc_painel_basico
cteste <- pnadc_painel_basico(build_data = FALSE,
dados_prontos = a)
View(pnadc_painel_basico)
devtools::document()
rm(list = c("loop", "pnadc_painel_basico"))
devtools:document()
library(devtools)
devtools::document()
devtools:load_all()
devtools::load_all()
a <- datazoom_pnadc('C:/Users/arthu/Documents/ECONOMIA/Datazoom/pnadcontinua',
'C:/Users/arthu/Documents/ECONOMIA/Datazoom/pnadcontinua/Dicionario_e_input',
c(1,2013))
b <- pnadc_painel_basico(build_data = TRUE,
local_dados = 'C:/Users/arthu/Documents/ECONOMIA/Datazoom/pnadcontinua',
local_dicionarios = 'C:/Users/arthu/Documents/ECONOMIA/Datazoom/pnadcontinua/Dicionario_e_input',
periodos = list(c(1,2013))
)
cteste <- pnadc_painel_basico(build_data = FALSE,
dados_prontos = a)
cteste <- pnadc_painel_basico(build_data = FALSE,
dados_prontos = a)
cteste <- pnadc_painel_basico(build_data = FALSE,
dados_prontos = a)
devtools::document()
devtools::load_all()
a <- datazoom_pnadc('C:/Users/arthu/Documents/ECONOMIA/Datazoom/pnadcontinua',
'C:/Users/arthu/Documents/ECONOMIA/Datazoom/pnadcontinua/Dicionario_e_input',
c(1,2013))
b <- pnadc_painel_basico(build_data = TRUE,
local_dados = 'C:/Users/arthu/Documents/ECONOMIA/Datazoom/pnadcontinua',
local_dicionarios = 'C:/Users/arthu/Documents/ECONOMIA/Datazoom/pnadcontinua/Dicionario_e_input',
periodos = list(c(1,2013))
)
cteste <- pnadc_painel_basico(build_data = FALSE,
dados_prontos = a)
View(cteste)
View(b)
View(a)
install.packages('DatazoomR')
library(DatazoomR)
setwd("~/ECONOMIA/Datazoom")
PNADC2012 <- datazoom_pnadc(diretorio_dados = getwd(),
diretorio_dicionario = './Dicionario_e_input',
c(1, 2012), c(2,2012))
getwd()
PNADC2012 <- datazoom_pnadc(diretorio_dados = './pnadcontinua',
diretorio_dicionario = './pnadcontinua/Dicionario_e_input',
c(1, 2012), c(2,2012))
View(PNADC2012)
painel <- pnadc_painel_basico(build_data = FALSE,
dados_prontos = PNADC2012)
loop <- function(data,
interview = 2,
int_final = 5){
data <- data %>%
group_by(UF, UPA, V1008, V1014, V2007,
V2008, V20081, V20082, V2003) %>%
fill(p201, .direction = 'down') %>%
mutate(p201 = ifelse(
n_p %in% 1:(interview-1),
p201,
ifelse(
n_p == interview  & is.na(p201) &
V2008 != 99 &
V20081 != 99 & V20082 != 9999,
100 * (n_p - 1) + V2003,
NA
)
))
if(interview == int_final){
return(data)
} else{
return(loop(data, interview + 1, int_final))
}
}
pnadc_painel_basico <- function(build_data = TRUE, ...){
argumentos <- list(...)
if (!(build_data) & is.null(argumentos$dados_prontos)) {
stop("Se build_data == FALSE, definir dados_prontos.
Ver help para detalhes")
}
if(build_data == TRUE &
(is.null(argumentos$local_dados) | is.null(argumentos$local_dicionario))
){
stop('Se build_data == TRUE, definir local_dados e local_dicionario,
Ver help para detalhes')
}
if(!build_data){
if(is.list(argumentos$dados_prontos) == FALSE){
dados_prontos <- as.list(argumentos$dados_prontos)
} else{
dados_prontos <- argumentos$dados_prontos
}
} else{
local_dados <- argumentos$local_dados
local_dicionario <- argumentos$local_dicionario
argumentos$local_pastas <- NULL
argumentos$local_dicionario <- NULL
dados_prontos <- do.call(datazoom_pnadc, c(local_dados,
local_dicionario,
argumentos$periodos))
}
paineis <- dados_prontos %>% do.call(rbind, .) %>%
split(.$V1014) %>%
setNames(., paste0('painel_', names(.))) %>%
map(~.x %>%
bind_cols(
### Adiciona identificadores
id_dom = group_indices(., UPA, V1008, V1014),
id_chefe = group_indices(., UPA, V1008, V1014, V2005)
) %>%
mutate(id_chefe = ifelse(V2005 != 1, NA, id_chefe)) %>%
group_by(id_chefe) %>%
mutate(n_p_aux = ifelse(V2005 != 1,
NA,
row_number())) %>%
group_by(id_dom, Ano, Trimestre) %>%
arrange(id_dom, Ano, Trimestre) %>%
mutate(n_p = mean(n_p_aux, na.rm = T)) %>%
ungroup() %>%
group_by(UF, UPA, V1008, V1014, V2007,
V2008, V20081, V20082, V2003) %>%
### Transforma NaN em NA's
mutate(n_p = ifelse(is.na(n_p), NA, n_p),
p201 = ifelse(n_p == 1 & V2008 != 99 &
V20081 != 99 & V20082 != 9999,
100*(n_p-1) + V2003, NA)) %>%
group_by(UF, UPA, V1008, V1014, V2007,
V2008, V20081, V20082, V2003) %>%
mutate(p201 = ifelse(n_p == 1  & V2008 != 99 &
V20081 != 99 & V20082 != 9999,
100*(n_p-1) + V2003, NA)) %>%
loop() %>%
ungroup() %>%
mutate_at(c('UF', 'UPA', 'V1008', 'p201'), as.character) %>%
mutate(UPA = str_pad(UPA,9, pad = "0"),
V1008 = str_pad(V1008,3, pad = "0"),
p201 = str_pad(p201,3, pad = "0")) %>%
mutate(idind = ifelse(is.na(p201),
NA,
paste0(V1014, UF, UPA, V1008, p201))) %>%
select(-c(p201, n_p, n_p_aux)) %>%
arrange(Ano, Trimestre, idind, UPA, V2003) %>%
set_variable_labels(.labels =  var_label(dados_prontos[[1]]))
)
return(paineis)
}
datazoom_pnadc <- function(diretorio_dados,
diretorio_dicionario,
...) {
datas <- list(...)
if (any(map(datas, length) != 2)) {stop('Escolha o mesmo nÃºmero de anos e trimestres', call. = FALSE)}
trimestre <- datas %>% map( ~ .x[[1]])
ano <- datas %>% map( ~ .x[[2]])
if (sum(trimestre %in% 1:4 == F) > 0) {stop('Escolha trimestres entre 1 e 4', call. = FALSE)}
if (sum(ano %in% 2012:2020 == F) > 0) {stop('Escolha anos entre 2012 e 2020', call. = FALSE)}
dic = read_excel(file.path(diretorio_dicionario,
'dicionario_das_variaveis_PNAD_Continua_microdados.xls'),
range = cell_cols("C:E"),
skip = 6,
col_names = c('Codigo_da_variavel',
'numero',
'descricao')
) %>%
select(Codigo_da_variavel, descricao) %>%
na.omit()
descricao = as.list(dic$descricao)
trimestre = str_pad(trimestre, width = 2, pad = 0)
names(descricao) = dic$Codigo_da_variavel
key = data.frame(trimyear = paste0(trimestre, ano) %>% as.character())
paths = key %>%  mutate(
date = ifelse(
trimyear %in% c("022019", "032019", "042019"),
paste0('PNADC_', trimyear),
paste0('PNADC_', trimyear, '_20190729')
),
filepath_in = file.path(diretorio_dados, paste0(date, '.txt'), sep = '')
)
filepath_in = paths$filepath_in
last = c(4, 5, 7, 9, 11, 20,
27, 29, 31, 32, 33,
34, 49, 64, 73, 76,
78, 80, 82, 83, 85,
87, 91, 94, 95, 96,
97, 98, 100, 102, 103,
104, 105, 107, 108, 109,
110, 112, 114, 115, 116,
117, 118, 120, 121, 122,
123, 124, 125, 126, 127,
128, 129, 130, 131, 132,
134, 136, 138, 139, 143,
144, 145, 150, 151, 152,
153, 154, 155, 156, 158,
159, 160, 162, 164, 165,
166, 167, 168, 169, 171,
173, 174, 175, 176, 177,
178, 179, 180, 181, 182,
183, 184, 185, 186, 187,
195, 196, 197, 205, 206,
207, 208, 209, 210, 218,
219, 220, 228, 231, 234,
235, 237, 239, 241, 245,
246, 247, 252, 253, 254,
255, 256, 257, 258, 259,
260, 268, 269, 270, 278,
279, 280, 281, 282, 283,
291, 292, 293, 301, 304,
307, 308, 309, 310, 311,
319, 320, 321, 329, 330,
331, 332, 333, 334, 335,
343, 344, 345, 353, 356,
359, 360, 361, 362, 363,
364, 366, 367, 368, 369,
371, 372, 374, 375, 377,
379, 381, 382, 383, 384,
385, 387, 389, 390, 391,
393, 394, 395, 396, 397,
398, 399, 400, 401, 402,
404, 406, 408, 409, 410,
411, 412, 420, 428, 429,
437, 445, 446, 447, 450,
453, 456, 459, 462, 463
)
vname = c("Ano", "Trimestre", "UF", "Capital", "RM_RIDE",
"UPA", "Estrato", "V1008","V1014", "V1016",
"V1022", "V1023", "V1027", "V1028", "V1029",
"posest", "V2001", "V2003", "V2005", "V2007",
"V2008", "V20081", "V20082", "V2009", "V2010",
"V3001", "V3002", "V3002A", "V3003", "V3003A",
"V3004", "V3005", "V3005A", "V3006", "V3006A",
"V3007", "V3008", "V3009", "V3009A", "V3010",
"V3011", "V3011A", "V3012", "V3013", "V3013A",
"V3013B", "V3014", "V4001", "V4002", "V4003",
"V4004", "V4005", "V4006", "V4006A", "V4007",
"V4008", "V40081", "V40082", "V40083", "V4009",
"V4010", "V4012", "V40121", "V4013", "V40132",
"V40132A", "V4014", "V4015", "V40151", "V401511",
"V401512", "V4016", "V40161", "V40162", "V40163",
"V4017", "V40171", "V401711", "V4018", "V40181",
"V40182", "V40183", "V4019", "V4020", "V4021",
"V4022", "V4024", "V4025", "V4026", "V4027",
"V4028", "V4029", "V4032", "V4033", "V40331",
"V403311", "V403312", "V40332", "V403321", "V403322",
"V40333", "V403331", "V4034", "V40341", "V403411",
"V403412", "V40342", "V403421", "V403422", "V4039",
"V4039C", "V4040", "V40401", "V40402", "V40403",
"V4041", "V4043", "V40431", "V4044", "V4045",
"V4046", "V4047", "V4048", "V4049", "V4050",
"V40501", "V405011", "V405012", "V40502", "V405021",
"V405022", "V40503", "V405031", "V4051", "V40511",
"V405111", "V405112", "V40512", "V405121", "V405122",
"V4056", "V4056C", "V4057", "V4058", "V40581",
"V405811", "V405812", "V40582", "V405821", "V405822",
"V40583", "V405831", "V40584", "V4059", "V40591",
"V405911", "V405912", "V40592", "V405921", "V405922",
"V4062", "V4062C", "V4063", "V4063A", "V4064",
"V4064A", "V4071", "V4072", "V4072A", "V4073",
"V4074", "V4074A", "V4075A", "V4075A1", "V4076",
"V40761", "V40762", "V40763", "V4077", "V4078",
"V4078A", "V4082", "VD2002", "VD2003", "VD2004",
"VD3004", "VD3005", "VD3006", "VD4001", "VD4002",
"VD4003", "VD4004", "VD4004A", "VD4005", "VD4007",
"VD4008", "VD4009", "VD4010", "VD4011", "VD4012",
"VD4013", "VD4014", "VD4015", "VD4016", "VD4017",
"VD4018", "VD4019", "VD4020", "VD4023", "VD4030",
"VD4031", "VD4032", "VD4033", "VD4034", "VD4035",
"VD4036", "VD4037"
)
fatores = c('Ano', 'Trimestre', 'UF', 'Capital', 'RM_RIDE',
'V1008', 'V1014', 'V1016', 'V1022', 'V1023',
'posest', 'V2005', 'V2007', 'V2008', 'V20081',
'V20082', 'V2010', 'V3001', 'V3002', 'V3002A',
'V3003', 'V3003A', 'V3004', 'V3005', 'V3005A',
'V3006', 'V3006A', 'V3007', 'V3008', 'V3009',
'V3009A', 'V3010', 'V3011', 'V3011A', 'V3012',
'V3013A', 'V3013B', 'V3014', 'V4001', 'V4002',
'V4003', 'V4004', 'V4005', 'V4006', 'V4006A',
'V4007', 'V4008', 'V4009', 'V4010', 'V4012',
'V40121', 'V4013', 'V40132', 'V40132A', 'V4014',
'V4015', 'V40151', 'V4016', 'V4017', 'V40171',
'V4018', 'V4019', 'V4020', 'V4021', 'V4022',
'V4024', 'V4025', 'V4026', 'V4027', 'V4028',
'V4029', 'V4032', 'V4033', 'V40331', 'V40331',
'V40332', 'V403321', 'V40333', 'V403331', 'V4034',
'V40341', 'V403411', 'V40342', 'V403421', 'V4040',
'V40403', 'V4043', 'V40431', 'V4044', 'V4045',
'V4046', 'V4047', 'V4048', 'V4049', 'V4050',
'V40501', 'V405011', 'V40502', 'V405021', 'V40503',
'V405031', 'V4051', 'V40511', 'V405111', 'V40512',
'V405121', 'V4057', 'V4058', 'V40581', 'V405811',
'V40582', 'V405821', 'V40583', 'V405831', 'V40584',
'V4059', 'V40591', 'V405911', 'V40592', 'V405921',
'V4063', 'V4063A', 'V4064', 'V4064A', 'V4071',
'V4072', 'V4072A', 'V4073', 'V4074', 'V4074A',
'V4075A', 'V4076', 'V4077', 'V4078', 'V4078A',
'V4082', 'VD2002', 'VD2004', 'VD3004', 'VD3005',
'VD3006', 'VD4001', 'VD4002', 'VD4003', 'VD4004',
'VD4004A', 'VD4005', 'VD4007', 'VD4008', 'VD4009',
'VD4010', 'VD4011', 'VD4012', 'VD4013', 'VD4014',
'VD4015', 'VD4018', 'VD4023', 'VD4030', 'VD4036',
'VD4037'
)
caracteres = c('UPA', 'Estrato', 'V4041')
numerico = c('V1027', 'V1028', 'V1029', 'V2001', 'V2003',
'V2009', 'V3013', 'V40081', 'V40082', 'V40083',
'V401511', 'V401512', 'V40161', 'V40162', 'V40163',
'V401711', 'V40181', 'V40182', 'V40183', 'V403312',
'V403322', 'V403412', 'V403422', 'V4039', 'V4039C',
'V40401', 'V40402', 'V405012', 'V405022', 'V405112',
'V405122', 'V4056', 'V4056C', 'V405812', 'V405822',
'V405912', 'V405922', 'V4062', 'V4062C', 'V4075A1',
'V40761', 'V40762', 'V40763', 'VD2003', 'VD4016',
'VD4017', 'VD4019', 'VD4020', 'VD4031', 'VD4032',
'VD4033', 'VD4034', 'VD4035'
)
DF = filepath_in %>% map(
~ .x %>% read_tsv(
.,
n_max = 1000,
col_names = 'a') %>%
separate(a, into = vname, sep = last)
)
names(DF) = paste0('PNADC_', trimestre, ano)
DF = DF %>% map(
~ .x %>% mutate_at(caracteres, as.character) %>%
mutate_at(numerico, as.numeric) %>%
mutate_at(fatores, as.factor) %>%
mutate(
hous_id = paste0(UPA, V1008, V1014),
ind_id = paste0(UPA, V1008, V1014, V2003)
) %>%
select(hous_id, ind_id, everything())
)
lista <- as.list(dic$descricao)
names(lista) <- as.list(dic$Codigo_da_variavel)
DF = DF %>% map(~ .x %>% set_variable_labels(.labels = lista))
return(DF)
}
loop <- function(data,
interview = 2,
int_final = 5){
data <- data %>%
group_by(UF, UPA, V1008, V1014, V2007,
V2008, V20081, V20082, V2003) %>%
fill(p201, .direction = 'down') %>%
mutate(p201 = ifelse(
n_p %in% 1:(interview-1),
p201,
ifelse(
n_p == interview  & is.na(p201) &
V2008 != 99 &
V20081 != 99 & V20082 != 9999,
100 * (n_p - 1) + V2003,
NA
)
))
if(interview == int_final){
return(data)
} else{
return(loop(data, interview + 1, int_final))
}
}
pnadc_painel_basico <- function(build_data = TRUE, ...){
argumentos <- list(...)
if (!(build_data) & is.null(argumentos$dados_prontos)) {
stop("Se build_data == FALSE, definir dados_prontos.
Ver help para detalhes")
}
if(build_data == TRUE &
(is.null(argumentos$local_dados) | is.null(argumentos$local_dicionario))
){
stop('Se build_data == TRUE, definir local_dados e local_dicionario,
Ver help para detalhes')
}
if(!build_data){
if(is.list(argumentos$dados_prontos) == FALSE){
dados_prontos <- as.list(argumentos$dados_prontos)
} else{
dados_prontos <- argumentos$dados_prontos
}
} else{
local_dados <- argumentos$local_dados
local_dicionario <- argumentos$local_dicionario
argumentos$local_pastas <- NULL
argumentos$local_dicionario <- NULL
dados_prontos <- do.call(datazoom_pnadc, c(local_dados,
local_dicionario,
argumentos$periodos))
}
paineis <- dados_prontos %>% do.call(rbind, .) %>%
split(.$V1014) %>%
setNames(., paste0('painel_', names(.))) %>%
map(~.x %>%
bind_cols(
### Adiciona identificadores
id_dom = group_indices(., UPA, V1008, V1014),
id_chefe = group_indices(., UPA, V1008, V1014, V2005)
) %>%
mutate(id_chefe = ifelse(V2005 != 1, NA, id_chefe)) %>%
group_by(id_chefe) %>%
mutate(n_p_aux = ifelse(V2005 != 1,
NA,
row_number())) %>%
group_by(id_dom, Ano, Trimestre) %>%
arrange(id_dom, Ano, Trimestre) %>%
mutate(n_p = mean(n_p_aux, na.rm = T)) %>%
ungroup() %>%
group_by(UF, UPA, V1008, V1014, V2007,
V2008, V20081, V20082, V2003) %>%
### Transforma NaN em NA's
mutate(n_p = ifelse(is.na(n_p), NA, n_p),
p201 = ifelse(n_p == 1 & V2008 != 99 &
V20081 != 99 & V20082 != 9999,
100*(n_p-1) + V2003, NA)) %>%
group_by(UF, UPA, V1008, V1014, V2007,
V2008, V20081, V20082, V2003) %>%
mutate(p201 = ifelse(n_p == 1  & V2008 != 99 &
V20081 != 99 & V20082 != 9999,
100*(n_p-1) + V2003, NA)) %>%
loop() %>%
ungroup() %>%
mutate_at(c('UF', 'UPA', 'V1008', 'p201'), as.character) %>%
mutate(UPA = str_pad(UPA,9, pad = "0"),
V1008 = str_pad(V1008,3, pad = "0"),
p201 = str_pad(p201,3, pad = "0")) %>%
mutate(idind = ifelse(is.na(p201),
NA,
paste0(V1014, UF, UPA, V1008, p201))) %>%
select(-c(p201, n_p, n_p_aux)) %>%
arrange(Ano, Trimestre, idind, UPA, V2003) %>%
set_variable_labels(.labels =  var_label(dados_prontos[[1]]))
)
return(paineis)
}
library(tidyverse)
library(labelled)
library(readxl)
PNADC2012 <- datazoom_pnadc(diretorio_dados = './pnadcontinua',
diretorio_dicionario = './pnadcontinua/Dicionario_e_input',
c(1, 2012), c(2,2012))
?datazoom_pnadc
painel <- pnadc_painel_basico(build_data = FALSE,
dados_prontos = PNADC2012)
View(PNADC2012)
View(PNADC2012)
View(painel)
lifecycle::last_warnings()
View(PNADC2012)
View(datazoom_pnadc)
View(pnadc_painel_basico)
library(DatazoomR)
painel <- DatazoomR::pnadc_painel_basico(build_data = FALSE,
dados_prontos = PNADC2012)
devtools::load_all(".")
getwd()
PNADC <- datazoom_pnadc(diretorio_dados = 'C:/Users/arthu/Documents/ECONOMIA/Datazoom/pnadcontinua',
diretorio_dicionario = 'C:/Users/arthu/Documents/ECONOMIA/Datazoom/pnadcontinua/Dicionario_e_input',
c(1,2000), c(2,2001))
PNADC <- datazoom_pnadc(diretorio_dados = 'C:/Users/arthu/Documents/ECONOMIA/Datazoom/pnadcontinua',
diretorio_dicionario = 'C:/Users/arthu/Documents/ECONOMIA/Datazoom/pnadcontinua/Dicionario_e_input',
c(1,2014), c(2,2016))
painnel <- pnadc_painel_basico(build_data = FALSE,
dados_prontos = PNADC)
View(painnel)
library(DatazoomR)
painnel <- pnadc_painel_basico(build_data = FALSE,
dados_prontos = PNADC)
